{%- macro render_hover_name(
    display_name,
    user_id=None,
    team_id=None,
    seats_by_user_id={},
    team_members_by_team_id={},
    truncate_len=0
) -%}
{%- set has_hover_data = (
    (team_id and team_id in team_members_by_team_id)
    or (user_id and user_id in seats_by_user_id)
) -%}
<span class="lt-hover-wrap">
  {%- if truncate_len > 0 -%}
    {{ display_name|truncate(truncate_len) }}
  {%- else -%}
    {{ display_name }}
  {%- endif -%}
  {%- if has_hover_data %}
  <span class="lt-hover-card">
    {%- if team_id and team_id in team_members_by_team_id -%}
      {%- for name, seat in team_members_by_team_id[team_id] %}
    <span class="lt-hover-member">{{ name }}{% if seat %} [{{ seat }}]{% endif %}</span>
      {%- endfor -%}
    {%- elif user_id and user_id in seats_by_user_id -%}
    <span class="lt-hover-seat">{{ seats_by_user_id[user_id] }}</span>
    {%- endif %}
  </span>
  {%- endif %}
</span>
{%- endmacro -%}

{%- macro hover_card_styles() -%}
<style>
.lt-hover-wrap {
  position: relative;
  cursor: help;
  display: inline-block;
  text-decoration: underline dotted;
}
.lt-hover-card {
  visibility: hidden;
  opacity: 0;
  pointer-events: none;
  position: absolute;
  bottom: 100%;
  left: 0;
  background: var(--bg-card, #ffffff);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border-color, #ccc);
  border-radius: var(--radius-md, var(--border-radius, 0.25rem));
  padding: 0.4rem 0.6rem;
  white-space: nowrap;
  z-index: 999;
  font-size: 0.8125rem;
  box-shadow: var(--shadow-soft, 0 2px 8px rgba(0, 0, 0, 0.15));
  margin-bottom: 4px;
  transition: opacity 0.15s ease, visibility 0.15s ease;
}
.lt-hover-wrap:hover .lt-hover-card {
  visibility: visible;
  opacity: 1;
  pointer-events: auto;
}
.lt-hover-member {
  display: block;
  line-height: 1.6;
}
.lt-hover-seat {
  font-weight: bold;
}
</style>
{%- endmacro -%}

{% macro render_bracket(match_data, tournament, teams_by_id={}, participants_by_id={}, seats_by_user_id={}, team_members_by_team_id={}) %}
{#
  Renders a tournament bracket visualization.

  Args:
    match_data: List of dicts with 'match' and 'contestants' keys
    tournament: Tournament object
#}

<style>
  .bracket-container {
    overflow-x: auto;
    padding: 2rem 0;
  }

  .bracket {
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    min-width: 800px;
  }

  .bracket-round {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    margin: 0 1rem;
  }

  .bracket-match {
    position: relative;
    margin: 1rem 0;
    min-width: 200px;
  }

  .bracket-match-card {
    background-color: #fff;
    border: 2px solid #ccc;
    border-radius: 4px;
    padding: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .bracket-match-card.confirmed {
    border-color: #28a745;
  }

  .bracket-match-header {
    font-size: 0.75rem;
    color: #666;
    margin-bottom: 0.5rem;
    text-align: center;
    font-weight: bold;
  }

  .bracket-contestant {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    margin: 0.25rem 0;
    background-color: #f5f5f5;
    border-radius: 3px;
  }

  .bracket-contestant.winner {
    background-color: #d4edda;
    font-weight: bold;
  }

  .bracket-contestant-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .bracket-contestant-score {
    font-weight: bold;
    margin-left: 0.5rem;
    min-width: 30px;
    text-align: right;
  }

  .bracket-connector {
    position: absolute;
    border-right: 2px solid #ccc;
    border-top: 2px solid #ccc;
    border-bottom: 2px solid #ccc;
    right: -20px;
    width: 20px;
  }

  .bracket-connector-group {
    position: relative;
  }

  .bracket-round-label {
    text-align: center;
    font-weight: bold;
    margin-bottom: 1rem;
    color: #333;
  }

  .bracket-slot.defwin {
    border-left: 4px solid #17a2b8;
    background-color: #e7f5f7;
  }

  .badge-defwin {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    font-weight: bold;
    color: #fff;
    background-color: #17a2b8;
    border-radius: 3px;
    margin-left: 0.5rem;
  }
</style>

<div class='bracket-container'>
  {%- if match_data %}
  <div class='bracket'>
    {# Group matches by round (using match_order as proxy) #}
    {%- set rounds = {} %}
    {%- for data in match_data %}
      {%- set match = data.match %}
      {%- set round_num = match.round if match.round is not none else 0 %}
      {%- if round_num not in rounds %}
        {%- set _ = rounds.update({round_num: []}) %}
      {%- endif %}
      {%- set _ = rounds[round_num].append(data) %}
    {%- endfor %}

    {# Render each round #}
    {%- for round_num in rounds.keys()|sort %}
    <div class='bracket-round'>
      <div class='bracket-round-label'>
        {%- if rounds|length == 1 %}
          {{ _('Final') }}
        {%- elif round_num == (rounds|length - 1) %}
          {{ _('Final') }}
        {%- elif round_num == (rounds|length - 2) %}
          {{ _('Semi-Finals') }}
        {%- elif round_num == (rounds|length - 3) %}
          {{ _('Quarter-Finals') }}
        {%- else %}
          {{ _('Round') }} {{ round_num + 1 }}
        {%- endif %}
      </div>

      {%- set round_matches = rounds[round_num] %}
      {%- for data in round_matches %}
      {%- set match = data.match %}
      {%- set contestants = data.contestants %}
      {%- set is_even_index = loop.index0 % 2 == 0 %}
      {%- set is_last_in_pair = loop.index0 % 2 == 1 %}
      {%- if is_even_index %}<div class='bracket-connector-group' style='position: relative;'>{%- endif %}
      <div class='bracket-match'>
        <div class='bracket-match-card {% if match.confirmed_by %}confirmed{% endif %} {% if contestants|length == 1 %}defwin{% endif %}'>
          <div class='bracket-match-header'>
            {{ _('Match') }} #{{ match.match_order }}
            {%- if contestants|length == 1 %}
              <span class='badge-defwin' title='{{ _("Free Win - Opponent advanced automatically") }}'>
                {{ _('defwin') }}
              </span>
            {%- endif %}
          </div>

          {%- for contestant in contestants %}
          {%- set is_winner = false %}
          {%- if match.confirmed_by and contestants|length == 2 %}
            {# Determine winner if match is confirmed #}
            {%- set other_contestant = contestants[1 if loop.index0 == 0 else 0] %}
            {%- if contestant.score is not none and other_contestant.score is not none %}
              {%- set is_winner = contestant.score > other_contestant.score %}
            {%- endif %}
          {%- endif %}

          <div class='bracket-contestant {% if is_winner %}winner{% endif %}'>
            <div class='bracket-contestant-name'>
              {%- if contestant.team_id %}
                {%- set _team = teams_by_id.get(contestant.team_id) -%}
                {%- if _team -%}
                  {{ render_hover_name(_team.name, team_id=_team.id, team_members_by_team_id=team_members_by_team_id, truncate_len=15) }}
                {%- else -%}
                  {{ contestant.team_id|string }}
                {%- endif -%}
              {%- elif contestant.participant_id %}
                {%- set _user = participants_by_id.get(contestant.participant_id) -%}
                {%- if _user -%}
                  {{ render_hover_name(_user.screen_name, user_id=_user.id, seats_by_user_id=seats_by_user_id, truncate_len=15) }}
                {%- else -%}
                  {{ contestant.participant_id|string }}
                {%- endif -%}
              {%- else %}
                BYE
              {%- endif %}
            </div>
            <div class='bracket-contestant-score'>
              {{ contestant.score|default('–', true) }}
            </div>
          </div>
          {%- endfor %}
          {%- if not contestants %}
          <div class='bracket-contestant'>
            <div class='bracket-contestant-name' style='color: #999;'>
              TBD
            </div>
            <div class='bracket-contestant-score'>–</div>
          </div>
          <div class='bracket-contestant'>
            <div class='bracket-contestant-name' style='color: #999;'>
              TBD
            </div>
            <div class='bracket-contestant-score'>–</div>
          </div>
          {%- endif %}
        </div>
      </div>
      {%- if is_last_in_pair or loop.last %}<div class='bracket-connector'></div></div>{%- endif %}
      {%- endfor %}
    </div>
    {%- endfor %}
  </div>
  {%- else %}
  <p class='dimmed' style='text-align: center;'>
    {{ _('Bracket not yet generated.') }}
  </p>
  {%- endif %}
</div>

{%- endmacro %}


{% macro render_simple_bracket_list(match_data, teams_by_id={}, participants_by_id={}, seats_by_user_id={}, team_members_by_team_id={}) %}
{#
  Simpler list-based bracket view for small screens or fallback.

  Args:
    match_data: List of dicts with 'match' and 'contestants' keys
#}

<div class='bracket-list'>
  {%- for data in match_data %}
  {%- set match = data.match %}
  {%- set contestants = data.contestants %}
  <div class='bracket-list-item'>
    <div class='bracket-list-header'>
      <strong>{{ _('Match') }} #{{ match.match_order }}</strong>
      {%- if match.confirmed_by %}
        <span style='color: #28a745; margin-left: 0.5rem;'>✓</span>
      {%- endif %}
    </div>
    <div class='bracket-list-matchup'>
      {%- if contestants|length == 1 %}
        {# Defwin match #}
        {%- set contestant = contestants[0] %}
        <div style='padding: 0.25rem 0;'>
          {%- if contestant.team_id %}
            {%- set _team = teams_by_id.get(contestant.team_id) -%}
            {%- if _team -%}
              {{ render_hover_name(_team.name, team_id=_team.id, team_members_by_team_id=team_members_by_team_id) }}
            {%- else -%}
              {{ contestant.team_id|string }}
            {%- endif -%}
          {%- elif contestant.participant_id %}
            {%- set _user = participants_by_id.get(contestant.participant_id) -%}
            {%- if _user -%}
              {{ render_hover_name(_user.screen_name, user_id=_user.id, seats_by_user_id=seats_by_user_id) }}
            {%- else -%}
              {{ contestant.participant_id|string }}
            {%- endif -%}
          {%- else %}
            BYE
          {%- endif %}
          <strong>{{ contestant.score|default('–', true) }}</strong>
          <span class='badge-defwin' title='{{ _("Free Win") }}'>{{ _('defwin') }}</span>
        </div>
      {%- else %}
        {# Normal match #}
        {%- for contestant in contestants %}
          <div style='padding: 0.25rem 0;'>
            {%- if contestant.team_id %}
              {%- set _team = teams_by_id.get(contestant.team_id) -%}
              {%- if _team -%}
                {{ render_hover_name(_team.name, team_id=_team.id, team_members_by_team_id=team_members_by_team_id) }}
              {%- else -%}
                {{ contestant.team_id|string }}
              {%- endif -%}
            {%- elif contestant.participant_id %}
              {%- set _user = participants_by_id.get(contestant.participant_id) -%}
              {%- if _user -%}
                {{ render_hover_name(_user.screen_name, user_id=_user.id, seats_by_user_id=seats_by_user_id) }}
              {%- else -%}
                {{ contestant.participant_id|string }}
              {%- endif -%}
            {%- else %}
              BYE
            {%- endif %}
            <strong>{{ contestant.score|default('–', true) }}</strong>
          </div>
          {%- if not loop.last %}
          <div style='text-align: center; color: #999;'>vs</div>
          {%- endif %}
        {%- endfor %}
      {%- endif %}
    </div>
  </div>
  {%- endfor %}
</div>

<style>
  .bracket-list {
    max-width: 600px;
    margin: 0 auto;
  }

  .bracket-list-item {
    background-color: #f5f5f5;
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .bracket-list-header {
    margin-bottom: 0.5rem;
  }

  .bracket-list-matchup {
    padding-left: 1rem;
  }
</style>

{%- endmacro %}


{% macro render_bracket_responsive_styles() %}<style>
  @media (max-width: 768px) {
    .bracket-desktop { display: none; }
    .bracket-mobile { display: block; }
  }
  @media (min-width: 769px) {
    .bracket-desktop { display: block; }
    .bracket-mobile { display: none; }
  }
</style>{%- endmacro %}
