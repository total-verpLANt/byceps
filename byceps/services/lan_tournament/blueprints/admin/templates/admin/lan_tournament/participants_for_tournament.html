{% extends 'layout/admin/lan_tournament.html' %}
{% set current_page_party = party %}
{% set current_tab = 'tournaments' %}
{% from 'macros/admin.html' import render_extra_in_heading %}
{% from 'macros/icons.html' import render_icon %}
{% from 'macros/lan_tournament.html' import render_hover_name, hover_card_styles %}
{% set page_title = [_('LAN'), party.title, _('Tournaments'), tournament.name, _('Participants')] %}

{% block head %}
  {{ hover_card_styles() }}
  <style>
    .participant-list .column-user {
      width: 30%;
    }
    .column-substitute {
      width: 10%;
      text-align: center;
    }
    .column-team {
      width: 20%;
    }
    .column-joined {
      width: 20%;
    }
    .column-ticket {
      width: 10%;
      text-align: center;
    }
  </style>
{%- endblock %}

{% block body %}

  <nav class="breadcrumbs">
    <ol>
      <li><a href="{{ url_for('.index', party_id=party.id) }}">{{ party.title }}</a></li>
      <li><a href="{{ url_for('.view', tournament_id=tournament.id) }}">{{ tournament.name }}</a></li>
    </ol>
  </nav>

  <h1 class="title">{{ _('Participants') }} {{ render_extra_in_heading(participants|length) }}</h1>

  {%- if tournament.tournament_status and tournament.tournament_status.name in ('REGISTRATION_OPEN', 'REGISTRATION_CLOSED') %}
  <div class="button-row">
    <a class="button" href="{{ url_for('.add_participant_form', tournament_id=tournament.id) }}">{{ render_icon('add') }} {{ _('Add participant') }}</a>
  </div>
  {%- endif %}

  {%- if participants %}
  {%- if participants_without_tickets %}
  <div class="button-row">
    <form action="{{ url_for('.remove_participants_without_tickets', tournament_id=tournament.id) }}" method="post" style="display: inline;">
      {%- if is_team_tournament %}
      <button type="submit" class="button is-warning" onclick="return confirm('{{ _('Remove %(count)s ticketless participants and transfer captain roles?', count=participants_without_tickets|length) }}');">
        {{ render_icon('delete') }} {{ _('Remove Ticketless Participants') }} ({{ participants_without_tickets|length }})
      </button>
      {%- else %}
      <button type="submit" class="button is-danger" onclick="return confirm('{{ _('Remove %(count)s participants without tickets?', count=participants_without_tickets|length) }}');">
        {{ render_icon('delete') }} {{ _('Remove All Without Tickets') }} ({{ participants_without_tickets|length }})
      </button>
      {%- endif %}
    </form>
  </div>
  {%- endif %}
  <table class="itemlist is-vcentered is-wide participant-list">
    <thead>
      <tr>
        <th class="column-user">{{ _('User') }}</th>
        <th class="column-substitute">{{ _('Substitute') }}</th>
        <th class="column-team">{{ _('Team') }}</th>
        <th class="column-joined">{{ _('Joined') }}</th>
        <th class="column-ticket">{{ _('Ticket') }}</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {%- for participant in participants %}
      <tr>
        <td class="column-user">
          {%- set _user = users_by_id.get(participant.user_id) -%}
          {%- if _user -%}
            {{ render_hover_name(_user.screen_name, user_id=_user.id, seats_by_user_id=seats_by_user_id) }}
          {%- else -%}
            {{ participant.user_id|string }}
          {%- endif -%}
        </td>
        <td class="column-substitute">
          {%- if participant.substitute_player %}
            {{ render_icon('enabled') }}
          {%- else %}
            <span class="dimmed">{{ render_icon('disabled') }}</span>
          {%- endif %}
        </td>
        <td class="column-team">
          {%- if participant.team_id %}
            {%- set _team = teams_by_id.get(participant.team_id) -%}
            {%- if _team -%}
              {{ render_hover_name(_team.name, team_id=_team.id, team_members_by_team_id=team_members_by_team_id) }}
            {%- else -%}
              {{ participant.team_id|string }}
            {%- endif -%}
          {%- else %}
            <span class="dimmed">-</span>
          {%- endif %}
        </td>
        <td class="column-joined">{{ participant.created_at|dateformat }}</td>
        <td class="column-ticket">
          {%- if participant.user_id in users_with_tickets %}
            <span class="tag is-success">{{ render_icon('success') }} {{ _('Valid') }}</span>
          {%- else %}
            <span class="tag is-danger">{{ render_icon('warning') }} {{ _('No ticket') }}</span>
          {%- endif %}
        </td>
        <td class="bared">
          <div class="button-row is-compact is-right-aligned">
            <form action="{{ url_for('.remove_participant', tournament_id=tournament.id, participant_id=participant.id) }}" method="post" style="display: inline;">
              <button type="submit" class="button is-compact" title="{{ _('Remove') }}" onclick="return confirm('{{ _('Remove participant?') }}');">{{ render_icon('delete') }}</button>
            </form>
          </div>
        </td>
      </tr>
      {%- endfor %}
    </tbody>
  </table>
  {%- else %}
  <div class="box">
    <div class="dimmed">{{ _('No participants have joined yet.') }}</div>
  </div>
  {%- endif %}

{%- endblock %}
